<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</title>
  <style>
    body { font-family: sans-serif; background: #f9f9f9; direction: rtl; padding: 20px; }
    .container { max-width: 700px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px #ccc; }
    input, button { padding: 10px; margin-top: 10px; width: 100%; border-radius: 5px; border: 1px solid #ccc; }
    #pagesList li { background: #f0f0f0; margin-top: 10px; padding: 10px; border-radius: 5px; list-style: none; }
    #refBox { background: #d4fcd4; padding: 10px; margin-top: 20px; border-radius: 5px; font-weight: bold; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Ù…Ø±Ø­Ø¨Ø§ Ø¨Ùƒ</h2>
    <p>ğŸ“§ <span id="userEmail">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span></p>
    <p>â­ Ù†Ù‚Ø§Ø·Ùƒ: <span id="points">0</span></p>

    <h3>Ø±Ø§Ø¨Ø· ØµÙØ­ØªÙƒ Ø¹Ù„Ù‰ ÙÙŠØ³Ø¨ÙˆÙƒ</h3>
    <input type="text" id="pageInput" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· ØµÙØ­ØªÙƒ">
    <button onclick="savePage()">ğŸ’¾ Ø­ÙØ¸</button>

    <div id="refBox">
      Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø©: <span id="refLink"></span>
      <button onclick="copyRef()">ğŸ“‹ Ù†Ø³Ø®</button>
    </div>

    <h3>ØªØ§Ø¨Ø¹ ØµÙØ­Ø§Øª Ø§Ù„Ø¢Ø®Ø±ÙŠÙ† Ù„ÙƒØ³Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø·</h3>
    <ul id="pagesList">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</ul>
  </div>

  <script type="module">
    import { supabase } from './supabase-config.js';

    let user, userId;

    async function init() {
      const session = (await supabase.auth.getSession()).data.session;
      if (!session) return location.href = "index.html";

      user = session.user;
      userId = user.id;
      document.getElementById("userEmail").innerText = user.email;

      const { data, error } = await supabase.from("users").select("*").eq("id", userId).single();

      if (data) {
        document.getElementById("points").innerText = data.points || 0;
        document.getElementById("pageInput").value = data.facebook_page || "";
        document.getElementById("refLink").innerText = `${location.origin}/index.html?ref=${userId}`;
        loadPages(data);
      }
    }

    async function savePage() {
      const url = document.getElementById("pageInput").value.trim();
      if (!url.startsWith("http")) return alert("Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­");
      await supabase.from("users").update({ facebook_page: url }).eq("id", userId);
      alert("âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸");
    }

    async function loadPages(currentUserData) {
      const list = document.getElementById("pagesList");
      const { data, error } = await supabase.from("users").select("*");

      if (error) return list.innerHTML = "âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø§Øª";

      const followed = currentUserData.followed_ids || [];

      const available = data.filter(u =>
        u.id !== userId &&
        u.facebook_page &&
        u.points > 0 &&
        !followed.includes(u.id)
      );

      if (available.length === 0) return list.innerHTML = "<li>Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙØ­Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</li>";

      list.innerHTML = "";
      available.forEach(user => {
        const li = document.createElement("li");
        li.innerHTML = `
          <a href="${user.facebook_page}" target="_blank">ğŸ”— ${user.email || "ØµÙØ­Ø©"}</a>
          <button onclick="confirmFollow('${user.id}')">âœ… ØªØ§Ø¨Ø¹Øª Ø§Ù„ØµÙØ­Ø©</button>
        `;
        list.appendChild(li);
      });
    }

    window.savePage = savePage;

    window.copyRef = () => {
      const link = document.getElementById("refLink").innerText;
      navigator.clipboard.writeText(link);
      alert("ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø©");
    };

    window.confirmFollow = async (targetId) => {
      if (!confirm("Ù‡Ù„ ØªØ§Ø¨Ø¹Øª Ø§Ù„ØµÙØ­Ø© ÙØ¹Ù„Ø§Ù‹ØŸ")) return;

      const { data: targetData } = await supabase.from("users").select("*").eq("id", targetId).single();
      if (!targetData || targetData.points < 1) {
        return alert("ØµØ§Ø­Ø¨ Ø§Ù„ØµÙØ­Ø© Ù„Ø§ ÙŠÙ…Ù„Ùƒ Ù†Ù‚Ø§Ø·Ø§Ù‹ ÙƒØ§ÙÙŠØ©.");
      }

      const userRes = await supabase.from("users").select("*").eq("id", userId).single();
      const currentPoints = userRes.data.points || 0;
      const followed = userRes.data.followed_ids || [];

      await supabase.from("users").update({
        points: currentPoints + 1,
        followed_ids: [...followed, targetId]
      }).eq("id", userId);

      await supabase.from("users").update({
        points: targetData.points - 1
      }).eq("id", targetId);

      alert("âœ… ØªÙ…Øª Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙˆØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø·Ø© Ù„Ùƒ");

      loadPages({ ...userRes.data, followed_ids: [...followed, targetId] });
    };

    init();
  </script>
</body>
</html>
