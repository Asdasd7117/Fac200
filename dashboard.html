<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>لوحة التحكم</title>
  <style>
    body {
      font-family: sans-serif;
      direction: rtl;
      background: #f0f8ff;
      padding: 20px;
    }
    .container {
      background: white;
      padding: 20px;
      max-width: 700px;
      margin: auto;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    input, button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      background: #f9f9f9;
      margin-top: 10px;
      padding: 10px;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>مرحباً بك</h2>
    <p id="userEmail"></p>
    <p>نقاطك: <span id="points">0</span></p>

    <h3>رابط صفحتك على فيسبوك</h3>
    <input type="text" id="pageInput" placeholder="أدخل رابط صفحتك">
    <button id="savePageBtn">حفظ الصفحة</button>

    <h3>تابع صفحات الآخرين لكسب النقاط</h3>
    <ul id="pagesList"></ul>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabase = createClient(
      'https://wwwdjpphvsdftfipwowa.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind3d2RqcHBodnNkZnRmaXB3b3dhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE3MTA3NTgsImV4cCI6MjA2NzI4Njc1OH0.vYAj3S_KpDcs7Rv1u_xA1rNYD042HtlPR1S9gEcHdAI'
    );

    let currentUser = null;
    let currentData = null;

    async function getUserData() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return location.href = "index.html";

      const user = session.user;
      currentUser = user;

      document.getElementById("userEmail").innerText = user.email;

      const { data } = await supabase.from("users").select("*").eq("id", user.id).single();
      currentData = data;

      document.getElementById("points").innerText = data?.points || 0;
      if (data?.facebook_page) {
        document.getElementById("pageInput").value = data.facebook_page;
      }

      loadOtherPages();
    }

    document.getElementById("savePageBtn").onclick = async () => {
      const url = document.getElementById("pageInput").value.trim();
      if (!url.startsWith("http")) return alert("رابط غير صالح");

      await supabase.from("users").update({ facebook_page: url }).eq("id", currentUser.id);
      alert("✅ تم حفظ رابط الصفحة");
      getUserData();
    };

    async function loadOtherPages() {
      const list = document.getElementById("pagesList");
      list.innerHTML = "جارٍ التحميل...";

      const { data, error } = await supabase.from("users").select("*");

      if (error) {
        list.innerHTML = "❌ خطأ أثناء تحميل الصفحات";
        return;
      }

      const myFollowers = currentData.followed_ids || [];
      const myId = currentUser.id;

      const others = data.filter(u =>
        u.id !== myId &&
        u.facebook_page &&
        (u.points || 0) > 0 &&
        !myFollowers?.includes(u.id)
      );

      if (others.length === 0) {
        list.innerHTML = "<p>لا توجد صفحات حالياً</p>";
        return;
      }

      list.innerHTML = "";
      others.forEach(u => {
        const li = document.createElement("li");
        li.innerHTML = `
          <p>${u.email}</p>
          <a href="${u.facebook_page}" target="_blank">افتح الصفحة</a>
          <button onclick="confirmFollow('${u.id}', '${u.points}')">تابعت</button>
        `;
        list.appendChild(li);
      });
    }

    window.confirmFollow = async (targetId, targetPoints) => {
      if (!confirm("هل تابعت هذه الصفحة فعلاً؟")) return;

      // تحديثي: المتابع يحصل على نقطة - صاحب الصفحة يخسر نقطة
      await supabase.from("users").update({
        points: (currentData.points || 0) + 1,
        followed_ids: [...(currentData.followed_ids || []), targetId]
      }).eq("id", currentUser.id);

      await supabase.from("users").update({
        points: targetPoints - 1
      }).eq("id", targetId);

      alert("✅ تمت المتابعة وتمت إضافة النقطة");
      getUserData();
    };

    getUserData();
  </script>
</body>
</html>
