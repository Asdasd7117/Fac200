<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f4f4f4;
      padding: 20px;
      direction: rtl;
    }
    .container {
      max-width: 600px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    input, button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    ul { list-style: none; padding: 0; }
    li {
      background: #eee;
      margin: 10px 0;
      padding: 10px;
      border-radius: 5px;
    }
    .ref-box {
      background: #d0f5d0;
      padding: 10px;
      margin-bottom: 10px;
      border: 2px solid green;
      text-align: left;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="ref-box">
      Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø©: 
      <button id="refBtn">Ø¹Ø±Ø¶</button>
      <div id="refArea" class="hidden" style="display:none;">
        <input type="text" id="refLink" readonly />
        <button id="copyRef">Ù†Ø³Ø®</button>
      </div>
    </div>

    <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ</h2>
    <p id="userEmail"></p>
    <p>Ù†Ù‚Ø§Ø·Ùƒ: <span id="points">0</span></p>

    <h3>Ø±Ø§Ø¨Ø· ØµÙØ­ØªÙƒ Ø¹Ù„Ù‰ ÙÙŠØ³Ø¨ÙˆÙƒ</h3>
    <input type="text" id="pageInput" placeholder="Ø¶Ø¹ Ø±Ø§Ø¨Ø· ØµÙØ­ØªÙƒ">
    <button id="savePageBtn">Ø­ÙØ¸</button>

    <h3>ØªØ§Ø¨Ø¹ ØµÙØ­Ø§Øª Ø§Ù„Ø¢Ø®Ø±ÙŠÙ† Ù„ÙƒØ³Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø·</h3>
    <ul id="pagesList"></ul>
  </div>

  <script type="module">
    import { supabase } from './supabase-config.js';

    let currentUser, userData;

    async function loadUser() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return location.href = "index.html";

      currentUser = session.user;

      const { data, error } = await supabase.from("users").select("*").eq("id", currentUser.id).single();
      if (error) return alert("ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");

      userData = data;
      document.getElementById("userEmail").innerText = userData.email;
      document.getElementById("points").innerText = userData.points || 0;

      // Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø©
      const refLink = `${location.origin}/index.html?ref=${currentUser.id}`;
      document.getElementById("refBtn").onclick = () => {
        document.getElementById("refArea").style.display = "block";
        document.getElementById("refLink").value = refLink;
      };
      document.getElementById("copyRef").onclick = () => {
        navigator.clipboard.writeText(refLink);
        alert("ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø©");
      };

      // Ø­ÙØ¸ Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ³Ø¨ÙˆÙƒ
      document.getElementById("pageInput").value = userData.facebook_page || "";
      document.getElementById("savePageBtn").onclick = async () => {
        const url = document.getElementById("pageInput").value.trim();
        if (!url.startsWith("http")) return alert("Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­");
        const { error } = await supabase.from("users").update({ facebook_page: url }).eq("id", currentUser.id);
        if (!error) alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø±Ø§Ø¨Ø·");
      };

      loadOtherPages();
    }

    async function loadOtherPages() {
      const list = document.getElementById("pagesList");
      list.innerHTML = "";

      const { data, error } = await supabase.from("users").select("*");
      if (error) return alert("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø§Øª");

      for (let user of data) {
        if (
          user.id === currentUser.id ||
          !user.facebook_page ||
          user.points < 1 ||
          (userData.followed_users || []).includes(user.id)
        ) continue;

        const li = document.createElement("li");
        const btnId = `btn_${user.id}`;
        const timerId = `t_${user.id}`;

        li.innerHTML = `
          <a href="${user.facebook_page}" target="_blank">ØµÙØ­Ø© ${user.email}</a><br>
          <button onclick="openPage('${user.facebook_page}', '${btnId}', '${timerId}')">Ø§ÙØªØ­ Ø§Ù„ØµÙØ­Ø©</button>
          <span id="${timerId}">â³ 10</span>
          <button id="${btnId}" onclick="confirmFollow('${user.id}', this)" disabled>ØªØ§Ø¨Ø¹Øª</button>
        `;
        list.appendChild(li);
      }
    }

    window.openPage = (url, btnId, timerId) => {
      window.open(url, '_blank');
      let count = 10;
      const sp = document.getElementById(timerId);
      const btn = document.getElementById(btnId);

      const iv = setInterval(() => {
        count--;
        sp.innerText = `â³ ${count}`;
        if (count <= 0) {
          clearInterval(iv);
          btn.disabled = false;
          sp.innerText = "âœ…";
        }
      }, 1000);
    };

    window.confirmFollow = async (targetId, btn) => {
      if (!confirm("Ù‡Ù„ ØªØ§Ø¨Ø¹Øª Ø§Ù„ØµÙØ­Ø© ÙØ¹Ù„Ø§Ù‹ØŸ")) return;

      // Ø§Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ø­Ø¨ Ø§Ù„ØµÙØ­Ø©
      const { data: targetData } = await supabase.from("users").select("*").eq("id", targetId).single();
      if (!targetData || targetData.points < 1) return alert("ØµØ§Ø­Ø¨ Ø§Ù„ØµÙØ­Ø© Ù„Ø§ ÙŠÙ…Ù„Ùƒ Ù†Ù‚Ø§Ø·Ø§Ù‹");

      // Ø£Ø¶Ù Ù†Ù‚Ø·Ø© Ù„Ùƒ ÙˆØ®ØµÙ… Ù…Ù† ØµØ§Ø­Ø¨ Ø§Ù„ØµÙØ­Ø©
      await supabase.from("users").update({
        points: (userData.points || 0) + 1,
        followed_users: [...(userData.followed_users || []), targetId],
        follow_count: (userData.follow_count || 0) + 1
      }).eq("id", currentUser.id);

      await supabase.from("users").update({
        points: targetData.points - 1
      }).eq("id", targetId);

      btn.parentElement.remove();
      alert("âœ… ØªÙ…Øª Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙˆÙƒØ³Ø¨Øª Ù†Ù‚Ø·Ø©");

      // ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø­Ø§Ù„Ø©
      const { data: updatedUser } = await supabase.from("users").select("*").eq("id", currentUser.id).single();
      if (
        updatedUser.follow_count >= 5 &&
        updatedUser.referrer &&
        !updatedUser.referral_credited
      ) {
        const { data: refUser } = await supabase.from("users").select("*").eq("id", updatedUser.referrer).single();
        await supabase.from("users").update({
          points: (refUser.points || 0) + 10
        }).eq("id", refUser.id);
        await supabase.from("users").update({
          referral_credited: true
        }).eq("id", currentUser.id);
        alert("ğŸ ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© 10 Ù†Ù‚Ø§Ø· Ù„Ù…ÙØ­ÙŠÙ„Ùƒ");
      }
    };

    loadUser();
  </script>
</body>
</html>
